# Agents 模块 API 和集成指南

## 核心 API 接口

### AgentConfig 类型定义
**位置**: `src/utils/agentLoader.ts`
**结构**:
```typescript
interface AgentConfig {
  agentType: string           // 代理类型标识符
  whenToUse: string           // 使用场景描述
  tools: string[]             // 可用工具列表
  systemPrompt: string        // 系统提示词
  color?: string              // 主题颜色（可选）
  // 其他扩展字段...
}
```

### AgentLoader 主要 API

#### getActiveAgents()
**功能**: 获取所有活跃代理配置
**返回**: `Promise<AgentConfig[]>`
**特性**: 带缓存，自动处理优先级

#### getAgentByType(agentType: string)
**功能**: 按类型获取特定代理配置
**返回**: `Promise<AgentConfig | null>`

#### clearAgentCache()
**功能**: 清理代理配置缓存
**使用场景**: 配置更新后强制重新加载

#### startAgentWatcher() / stopAgentWatcher()
**功能**: 启动/停止文件系统监控
**特性**: 支持配置热重载

## 组件间集成点

### 与 ModelManager 集成
**集成方式**: ModelStep 组件使用 `getModelManager()`
**功能**: 
- 获取可用模型列表
- 处理模型选择逻辑
- 支持默认模型继承

### 与权限系统集成
**相关组件**: ToolsStep, EditToolsStep
**功能**: 
- 检查工具使用权限
- 处理权限请求流程
- 工具可用性验证

### 与完成系统集成
**相关组件**: AgentCompletionUtility
**功能**: 
- 提供代理自动完成建议
- 集成到统一完成系统
- 智能建议排序算法

### 与消息系统集成
**相关组件**: TaskProgressMessage, TaskToolMessage
**功能**:
- 显示任务执行进度
- 代理工具使用状态反馈
- 颜色主题一致性

## 事件系统集成

### 键盘事件处理
**处理位置**: AgentsUI 主组件
**支持事件**:
- `ESC`: 模式回退
- `Enter`: 确认操作
- `Tab`: 功能切换
- `↑/↓`: 选项导航

### 文件系统事件
**处理位置**: AgentLoader 监控系统
**监听事件**:
- 配置文件创建/修改/删除
- 目录结构变化
- 配置热重载触发

## 配置存储架构

### 文件格式规范
**格式**: YAML frontmatter + Markdown
**示例**:
```markdown
---
agentType: "code-review"
whenToUse: "代码审查和质量保证"
tools:
  - "CodeReview"
  - "StaticAnalysis"
systemPrompt: "你是一个代码审查专家..."
color: "blue"
---

# 代理文档内容
详细的使用说明和示例...
```

### 存储位置优先级
1. **内置代理**: `builtin/` 目录
2. **用户级配置**: 
   - `~/.kode/agents/`
3. **项目级配置**:
  - `./.kode/agents/`

## 扩展 API

### 自定义工具集成
**集成方式**: 在代理配置中声明工具
**要求**:
- 工具必须已在系统中注册
- 需要相应的使用权限
- 符合工具接口规范

### 模型配置扩展
**支持特性**:
- 模型特定参数配置
- 温度、最大token等设置
- 模型提供商特定选项

### 颜色主题系统
**可用颜色**: 预定义的主题颜色集合
**扩展性**: 支持自定义颜色配置

## 错误处理和验证

### 配置验证规则
1. **标识符唯一性**: agentType 必须唯一
2. **工具存在性**: 声明的工具必须已注册
3. **模型可用性**: 选择的模型必须可用
4. **颜色有效性**: 颜色必须在预定义范围内

### 错误处理策略
- 配置加载失败时使用缓存数据
- 无效配置自动跳过
- 提供详细的错误日志

## 性能优化

### 缓存策略
**内存缓存**: 代理配置内存缓存
**缓存失效**: 文件变化时自动失效
**缓存清理**: 手动清理接口

### 懒加载机制
**组件懒加载**: 步骤组件按需加载
**数据懒加载**: 代理列表分批加载

### 监控和统计
**性能指标**:
- 配置加载时间
- 缓存命中率
- 内存使用情况

## 安全考虑

### 权限控制
- 工具使用权限验证
- 文件系统访问控制
- 配置修改权限检查

### 输入验证
- 代理标识符格式验证
- 工具名称白名单验证
- 模型参数范围检查

### 审计日志
- 配置修改记录
- 工具使用日志
- 异常操作监控

这个 API 和集成指南提供了 Agents 模块的完整接口说明，支持灵活的扩展和定制。
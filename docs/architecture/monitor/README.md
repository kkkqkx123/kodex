# Monitor 监控模块

## 概述

Monitor 模块是 Kode CLI 的核心监控系统，负责工具调用循环检测、失败监控、历史记录管理和配置管理。该模块通过实时监控工具调用行为，防止无限循环和重复失败，确保系统的稳定性和可靠性。

## 组件功能说明

### 1. 核心监控组件

#### ToolCallMonitor (工具调用监控器)
- **功能**: 主监控器，协调所有监控功能
- **所属模块**: 核心监控
- **主要职责**:
  - 工具调用开始和结束的事件处理
  - 循环检测和错误处理
  - 配置管理和状态控制
  - 日志记录和监控状态管理

#### ToolCallFailureMonitor (工具调用失败监控器)
- **功能**: 监控工具调用失败情况
- **所属模块**: 失败监控
- **主要职责**:
  - 检测连续失败次数
  - 识别失败类型（格式错误、diff反复等）
  - 触发自动压缩机制
  - 失败记录管理

#### ToolCallHistory (工具调用历史记录)
- **功能**: 管理工具调用历史记录
- **所属模块**: 历史管理
- **主要职责**:
  - 记录工具调用信息
  - 提供历史记录查询功能
  - 历史记录长度控制
  - 记录比较和去重

#### CycleDetector (循环检测器)
- **功能**: 检测工具调用循环
- **所属模块**: 循环检测
- **主要职责**:
  - 检测不同步长的循环模式
  - 提供循环检测算法
  - 支持部分循环检测
  - 序列相似性计算

### 2. 配置管理组件

#### ConfigManager (配置管理器)
- **功能**: 管理监控配置
- **所属模块**: 配置管理
- **主要职责**:
  - 配置文件的加载和保存
  - 配置验证和默认值处理
  - 配置文件路径管理
  - 配置同步和异步操作

### 3. 类型定义组件

#### types.ts (类型定义)
- **功能**: 定义监控模块的类型
- **所属模块**: 类型系统
- **主要职责**:
  - 定义工具调用记录接口
  - 定义监控配置接口
  - 定义循环检测结果接口
  - 定义循环错误类

#### failureTypes.ts (失败类型定义)
- **功能**: 定义失败类型和检测逻辑
- **所属模块**: 失败处理
- **主要职责**:
  - 定义失败类型枚举
  - 提供失败类型检测函数
  - 定义工具调用结果记录接口
  - 失败内容分析逻辑

## 模块架构特点

### 1. 分层设计
- **核心层**: ToolCallMonitor 作为主协调器
- **功能层**: 各专项监控组件（失败监控、循环检测等）
- **数据层**: 历史记录管理和配置管理
- **类型层**: 统一的类型定义系统

### 2. 模块化架构
- 每个组件职责单一，易于测试和维护
- 组件间通过清晰的接口进行通信
- 支持功能的热插拔和配置

### 3. 可配置性
- 通过配置文件控制监控行为
- 支持运行时配置更新
- 提供丰富的配置选项

### 4. 错误处理
- 专门的失败类型检测系统
- 自动压缩机制防止无限失败
- 详细的日志记录和错误信息

## 配置选项

监控模块支持以下配置选项：

| 配置项 | 默认值 | 描述 |
|--------|--------|------|
| maxCycleSteps | 5 | 最大循环检测步长 |
| maxHistorySteps | 10 | 最大历史记录步数 |
| enabled | true | 是否启用监控 |
| terminateOnCycle | true | 检测到循环时是否终止任务 |
| logLevel | 'warn' | 日志级别 |
| failureMonitorEnabled | true | 失败监控是否启用 |
| autoCompactFailureThreshold | 3 | 触发自动压缩的连续失败次数 |

## 使用示例

```typescript
import { ToolCallMonitor } from '../monitor';

// 创建监控器实例
const monitor = new ToolCallMonitor();

// 工具调用开始时记录
monitor.onToolCallStart({
  id: 'tool-123',
  name: 'search_codebase',
  input: { query: 'test' },
  timestamp: Date.now()
});

// 工具调用结束时记录结果
monitor.onToolCallResult({
  id: 'tool-123',
  name: 'search_codebase',
  content: '搜索结果',
  timestamp: Date.now(),
  is_error: false
});
```

## 扩展指南

1. **添加新的失败类型**: 在 `failureTypes.ts` 中扩展 `FailureType` 枚举和检测逻辑
2. **自定义循环检测算法**: 继承或修改 `CycleDetector` 类
3. **集成新的监控功能**: 通过 `ToolCallMonitor` 的事件接口进行集成
4. **调整配置选项**: 在 `config.ts` 中修改默认配置和验证逻辑
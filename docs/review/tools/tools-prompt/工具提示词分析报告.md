# 工具提示词分析报告

## 工具提示词注入机制分析

### 注入流程
1. **工具schema生成**：在`src/services/claude.ts`中，通过以下代码生成工具schema：
   ```typescript
   const toolSchemas = await Promise.all(
     tools.map(async tool => ({
       name: tool.name,
       description: typeof tool.description === 'function' 
         ? await tool.description() 
         : tool.description,
       input_schema: zodToJsonSchema(tool.inputSchema),
     }))
   )
   ```

2. **系统提示词格式化**：在`src/query.ts`中，通过`formatSystemPromptWithContext()`函数格式化系统提示词

3. **AI模型调用**：将工具schema和系统提示词一起传递给AI模型，AI根据这些信息决定工具调用

### 当前问题分析

#### Task工具问题
- AI经常忘记提供`subagent_type`参数
- AI使用错误的函数调用语法（如`Task(...)`而不是JSON对象）
- 参数格式验证失败导致`InputValidationError`

#### TodoWrite工具问题  
- AI经常忘记提供完整的todos数组
- AI使用错误的JSON格式
- 缺少必需的字段（id、status、priority）

## 提示词修改建议

### Task工具提示词修改建议

**当前问题**：
- 缺少对`subagent_type`参数的强制要求说明
- 缺少清晰的错误示例
- 参数格式说明不够明确

**修改建议**：
1. 在"Required Input Format"部分增加对`subagent_type`的强制要求
2. 添加错误示例和正确示例的对比
3. 强调必须使用JSON对象格式而不是函数调用语法
4. 增加参数验证失败的后果说明

### TodoWrite工具提示词修改建议

**当前问题**：
- 缺少对完整todos数组的强制要求说明
- 缺少ID唯一性验证的强调
- 状态转换规则说明不够清晰

**修改建议**：
1. 在"Required Input Format"部分强调必须提供完整的todos数组
2. 增加ID唯一性验证的强制要求说明
3. 明确状态转换规则（如只能有一个in_progress任务）
4. 添加参数验证失败的后果说明

### 通用改进建议

1. **增加错误示例**：为每个工具提供常见的错误调用示例和正确的调用示例
2. **强化格式要求**：明确强调必须使用JSON对象格式
3. **添加验证说明**：说明参数验证失败的后果和调试方法
4. **改进场景描述**：更清晰地描述何时使用/不使用该工具

## 实施计划

1. **优先级**：先修改Task工具的提示词，解决`subagent_type`缺失问题
2. **测试验证**：修改后通过测试脚本验证提示词效果
3. **迭代优化**：根据实际使用情况持续优化提示词内容
4. **文档更新**：将修改建议更新到开发文档中

## 预期效果

通过提示词优化，预计可以：
- 减少80%的`InputValidationError`错误
- 提高工具调用的准确性和成功率
- 改善AI模型对工具参数格式的理解
- 提升用户体验和开发效率
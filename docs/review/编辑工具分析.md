# Kode 项目编辑工具分析

## 概述

Kode 项目提供了多种文件编辑工具，支持不同类型的文件操作。这些工具位于 `src/tools/` 目录下，每个工具都有特定的功能和用途。

## 主要编辑工具

### 1. FileEditTool - 文件编辑工具

**位置**: `src/tools/FileEditTool/FileEditTool.tsx`

**功能**:
- 替换文件中的特定文本内容
- 支持创建新文件（当 `old_string` 为空时）
- 支持删除内容（当 `new_string` 为空时）
- 提供详细的差异显示和验证机制

**编辑方式**:
- 基于字符串替换的精确编辑
- 支持单次替换操作
- 自动检测文件编码和换行符
- 提供安全验证（文件存在性检查、修改时间检查）

**输入参数**:
```typescript
{
  file_path: string,    // 文件绝对路径
  old_string: string,   // 要替换的文本
  new_string: string    // 替换后的文本
}
```

### 2. FileWriteTool - 文件写入工具

**位置**: `src/tools/FileWriteTool/FileWriteTool.tsx`

**功能**:
- 完全替换文件内容
- 创建新文件
- 支持大文件处理（截断显示）
- 提供创建和更新两种操作类型

**编辑方式**:
- 整体文件内容替换
- 自动处理文件编码和换行符
- 支持文件创建和完整重写

**输入参数**:
```typescript
{
  file_path: string,  // 文件绝对路径
  content: string     // 要写入的内容
}
```

### 3. MultiEditTool - 批量编辑工具

**位置**: `src/tools/MultiEditTool/MultiEditTool.tsx`

**功能**:
- 原子性地执行多个编辑操作
- 支持顺序应用多个替换操作
- 提供批量编辑的事务性保证
- 支持替换所有匹配项（`replace_all` 选项）

**编辑方式**:
- 顺序执行多个编辑操作
- 支持原子性操作（全部成功或全部失败）
- 提供详细的错误报告和回滚机制

**输入参数**:
```typescript
{
  file_path: string,  // 文件绝对路径
  edits: [            // 编辑操作数组
    {
      old_string: string,   // 要替换的文本
      new_string: string,   // 替换后的文本
      replace_all?: boolean // 是否替换所有匹配项
    }
  ]
}
```

### 4. NotebookEditTool - 笔记本编辑工具

**位置**: `src/tools/NotebookEditTool/NotebookEditTool.tsx`

**功能**:
- 专门用于编辑 Jupyter Notebook (.ipynb) 文件
- 支持单元格的替换、插入和删除操作
- 维护笔记本的 JSON 结构完整性
- 自动重置执行计数和输出

**编辑方式**:
- 单元格级别的精确编辑
- 支持三种编辑模式：
  - `replace`: 替换单元格内容
  - `insert`: 插入新单元格
  - `delete`: 删除单元格
- 自动处理笔记本元数据

**输入参数**:
```typescript
{
  notebook_path: string,  // 笔记本文件绝对路径
  cell_number: number,    // 单元格索引（0-based）
  new_source: string,     // 新的单元格内容
  cell_type?: 'code' | 'markdown', // 单元格类型
  edit_mode?: 'replace' | 'insert' | 'delete' // 编辑模式
}
```

### 5. FileReadTool - 文件读取工具

**位置**: `src/tools/FileReadTool/FileReadTool.tsx`

**功能**:
- 读取文件内容
- 支持大文件的分段读取（offset/limit）
- 自动检测文件类型（文本/图像）
- 提供文件存在性检查和权限验证

## 工具特性对比

| 工具名称 | 主要功能 | 适用场景 | 并发安全 | 只读 |
|---------|---------|---------|---------|------|
| FileEditTool | 精确文本替换 | 小范围内容修改 | 否 | 否 |
| FileWriteTool | 整体文件重写 | 创建新文件或完全重写 | 否 | 否 |
| MultiEditTool | 批量编辑 | 需要原子性多个操作 | 否 | 否 |
| NotebookEditTool | 笔记本编辑 | Jupyter Notebook 文件 | 否 | 否 |
| FileReadTool | 文件读取 | 查看文件内容 | 是 | 是 |

## 底层工具函数

### 文件操作工具 (src/utils/file.ts)

提供通用的文件操作功能：
- `readTextContent()` - 读取文本内容
- `writeTextContent()` - 写入文本内容
- `detectFileEncoding()` - 检测文件编码
- `detectLineEndings()` - 检测换行符类型
- `detectRepoLineEndings()` - 检测仓库换行符约定

### 编辑应用工具 (src/tools/FileEditTool/utils.ts)

提供编辑操作的核心实现：
- `applyEdit()` - 应用编辑操作并生成差异补丁
- 支持创建、替换、删除操作
- 生成结构化差异信息

## 安全特性

所有编辑工具都包含以下安全机制：

1. **文件权限检查** - 通过 `hasWritePermission()` 验证写权限
2. **时间戳验证** - 检查文件是否在读取后被修改
3. **二进制文件保护** - 阻止对二进制文件的编辑
4. **存在性验证** - 确保操作的文件存在
5. **内容验证** - 验证要替换的内容确实存在于文件中

## 使用建议

1. **简单替换** - 使用 `FileEditTool`
2. **创建新文件** - 使用 `FileWriteTool` 或 `FileEditTool`（old_string 为空）
3. **批量操作** - 使用 `MultiEditTool`
4. **笔记本文件** - 使用 `NotebookEditTool`
5. **查看内容** - 使用 `FileReadTool`

## 扩展性

工具系统采用统一的接口设计，易于扩展新的编辑工具。每个工具都实现相同的 `Tool` 接口，确保一致的行为和用户体验。
# CLI渲染清理机制分析与修复方案

## 问题描述
当前在终端窗口外的UI部分刷新时会残留，新的UI渲染前旧内容没有完全删除。

## 渲染架构分析

### 1. 整体渲染流程
```
cli.tsx (入口)
    ↓
render() - 创建Ink实例
    ↓
REPL.tsx (主组件)
    ↓
MessageContainer (消息容器)
    ↓
MessageRenderer (消息渲染器)
    ↓
Static组件 / 动态组件
```

### 2. 关键组件分析

#### 2.1 cli.tsx
- **作用**：CLI入口点，负责初始化和渲染
- **清理机制**：
  - 保存Ink实例到`global.inkInstance`
  - 进程退出时清理：SIGTERM、exit事件
  - PowerShell特殊处理：内存泄漏修复

#### 2.2 REPL.tsx
- **作用**：主交互界面
- **渲染内容**：
  - Logo和项目引导（Static组件）
  - 消息列表（Static + 动态）
  - 加载状态Spinner
  - 工具UI和对话框

#### 2.3 MessageRenderer.tsx
- **作用**：消息渲染核心
- **关键特性**：
  - 使用Static组件渲染已完成的静态内容
  - 动态渲染进行中的消息
  - PowerShell特殊优化

### 3. 清理机制现状

#### 3.1 现有清理函数

**clearTerminal()** (terminal.ts):
- 使用ANSI转义序列清理终端
- Windows使用`cls`命令，Unix使用ANSI序列
- 支持渐进式清理：标准 → 强制 → 重置

**forceClearTerminal()**:
- 更激进的ANSI序列清理
- 包含软重置和属性重置

**resetTerminal()**:
- 完整的终端状态重置
- 恢复主屏幕，重置所有属性

#### 3.2 当前问题

1. **Static组件残留**：Static渲染的内容不会自动清理
2. **Ink实例未清理**：只清理终端，未清理Ink渲染缓存
3. **PowerShell优化干扰**：特殊渲染逻辑可能影响清理
4. **内存泄漏**：渲染实例未正确释放

### 4. 修复方案

#### 4.1 增强清理机制

**新的清理策略**：
1. 先清理Ink实例缓存
2. 执行终端清理
3. 强制重新渲染
4. 释放相关资源

#### 4.2 代码修改

**需要修改的文件**：
1. `utils/terminal.ts` - 增强清理函数
2. `screens/REPL.tsx` - 添加清理钩子
3. `screens/REPL/MessageRenderer.tsx` - 优化Static组件使用
4. `entrypoints/cli.tsx` - 增强退出清理

#### 4.3 实施步骤

**步骤1**：增强terminal.ts清理函数
- 添加Ink实例清理
- 添加渲染强制重置
- 添加内存泄漏检测

**步骤2**：修改REPL组件
- 添加清理钩子
- 优化Static组件渲染
- 添加渲染状态管理

**步骤3**：测试验证
- 创建清理测试脚本
- 验证PowerShell兼容性
- 性能影响评估

### 5. 预期效果

1. **完全清理**：新旧UI切换时无残留
2. **性能优化**：减少内存占用
3. **跨平台兼容**：Windows和Unix系统一致体验
4. **稳定性提升**：减少渲染相关崩溃

### 6. 监控指标

1. **清理成功率**：99%+
2. **内存使用**：峰值降低30%
3. **渲染延迟**：清理操作<100ms
4. **PowerShell兼容性**：无特殊问题

## 使用建议

1. **开发测试**：使用`npm run test:clear`验证清理功能
2. **生产监控**：监控内存使用和清理失败率
3. **用户反馈**：收集终端残留问题的用户反馈
4. **定期优化**：每季度评估清理机制效果
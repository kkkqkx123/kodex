# UI残留问题修复记录

## 问题描述

**现象：** 旧的补全UI元素没有被正确清除，导致界面堆叠和重叠

**具体表现：**
- 输入从`/a`改为`/ag`时，旧的`/a`相关命令列表仍然显示
- 新的`/ag`补全列表显示在旧列表上方，形成UI堆叠
- 形成视觉上的"鬼影"效果

## 根本原因

这是一个**Ink静态渲染框架的固有问题**：

1. **静态渲染特性**：Ink不像Web浏览器那样自动清除之前的渲染内容
2. **状态变化间隙**：当suggestions数组从有内容→空→新内容时，可能出现中间状态残留
3. **缺少强制重新挂载**：组件没有基于输入内容变化的唯一标识

## 解决方案

### 1. 强制卸载-重新挂载机制（激进方案）
- 使用useState控制组件可见性，实现短暂卸载期
- 当输入上下文变化时，先完全隐藏组件（卸载），然后重新显示
- 使用10ms的短暂延迟确保Ink完全清除旧的渲染内容

### 2. 强制重新渲染key
- 使用renderKey计数器确保每次上下文变化都生成新的渲染key
- 结合输入前缀、suggestions长度等生成强制重新渲染标识

### 3. 智能上下文检测
- 监控输入前缀变化（前5个字符）识别上下文切换
- 当suggestions为空时立即隐藏组件
- 使用prevInputRef跟踪输入变化历史

### 4. 严格条件渲染
- 使用isVisible状态控制组件渲染，确保完全卸载
- 当输入从"/a"变为"/ag"时触发强制清除机制

## 文件变更

### 新增文件
- 无

### 修改文件
- `src/components/CompletionSuggestions.tsx` - 添加`useState`用于控制组件可见性（isVisible, renderKey）
  - 实现强制卸载-重新挂载机制：
    - 使用`prevInputRef`跟踪输入变化
    - 当输入前缀变化时触发短暂卸载（10ms）
    - 使用`forceRenderKey`确保强制重新渲染
  - 移除之前的复杂上下文检测，改为简单的输入前缀监控
  - 当suggestions为空时立即隐藏组件
- `src/components/PromptInput.tsx` - 保持原有`input`属性传递，用于强制重新渲染机制

## 验证结果

- ✅ **TypeScript编译通过**
- ✅ **输入变化时补全列表正确更新**
- ✅ **旧的UI元素被完全清除，无残留**
- ✅ **不会出现UI堆叠现象**

## 技术细节

修复使用了以下技术手段：

1. **唯一key生成**：结合输入前缀、建议数量和首个建议值
2. **强制重新挂载**：通过React的key机制强制组件重新创建
3. **状态追踪**：使用useRef跟踪建议变化，检测上下文切换
4. **严格条件渲染**：确保空状态时立即返回null

这个修复解决了Ink框架在快速状态变化时的UI残留问题。
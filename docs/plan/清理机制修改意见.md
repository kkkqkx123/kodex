基于我对代码的深入分析，我发现了导致终端UI堆叠问题的几个关键原因：

## 🔍 问题根本原因分析

### 1. **Static组件持久化机制缺陷**
在<mcsymbol name="MessageRenderer" filename="MessageRenderer.tsx" path="src/screens/REPL/MessageRenderer.tsx" startline="1" type="function"></mcsymbol>中，Logo和Onboarding组件始终被渲染为Static类型，即使内容超过一页也不会自动清理。这些Static组件设计为持久化显示，但在多页内容场景下会造成残留。

### 2. **清理调用时机不足**
从<mcsymbol name="REPL" filename="REPL.tsx" path="src/screens/REPL.tsx" startline="1" type="function"></mcsymbol>中可以看到，清理函数主要在用户交互时调用（如消息选择器），但缺少在以下关键节点的自动清理：
- 消息数量显著变化时
- 内容超过一页大小时  
- UI状态切换时

### 3. **滚动缓冲区处理不完善**
虽然<mcfile name="terminal.ts" path="src/utils/terminal.ts"></mcfile>中的ANSI序列 `\x1b[2J\x1b[3J\x1b[H` 理论上应该清除滚动缓冲区，但某些终端环境（特别是Windows PowerShell）可能不完全支持这些序列。

### 4. **虚拟化阈值设置不合理**
在<mcsymbol name="MessageContainer" filename="MessageContainer.tsx" path="src/screens/REPL/MessageContainer.tsx" startline="1" type="function"></mcsymbol>中，`VIRTUALIZATION_THRESHOLD = 15` 设置过高，应该在内容接近一页大小时就启用更激进的清理策略。

### 5. **缺乏内容感知的清理机制**
当前清理机制没有根据内容长度动态调整清理策略，导致：
- 一页以内内容：清理正常
- 超过一页内容：清理不彻底，Static组件残留

## 🛠️ 建议的修复方案

### 1. 增强自动清理机制
在REPL组件中添加内容长度监听，当检测到内容超过一页时自动调用`completeTerminalCleanup()`。

### 2. 改进Static组件管理
优化MessageRenderer中的Static组件策略，在内容较多时强制使用transient模式。

### 3. 增强终端兼容性处理
在terminal.ts中增加针对不同终端的特殊处理逻辑，特别是Windows PowerShell环境。

### 4. 调整虚拟化阈值
将`VIRTUALIZATION_THRESHOLD`从15降低到8-10，提前启用虚拟化和清理机制。

### 5. 添加滚动缓冲区专项清理
在清理函数中增加专门的滚动缓冲区清理逻辑，确保多页内容被完全清除。

这些修改将确保终端UI在各种内容长度下都能正确清理，解决超出页面时的堆叠问题。
        